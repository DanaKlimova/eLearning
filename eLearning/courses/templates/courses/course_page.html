{% extends 'main/base.html' %}
{% load course_extras %}

{% block title %}
Course page
{% endblock %}

{% block styles %}
{% load static %}
<link rel="stylesheet" href="{% static 'courses/css/course_page.css' %}" />
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="modalId" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Please, rate course</h4>
      </div>
      <div class="modal-body">
        <form>
            {% csrf_token %}
            <div class="rate">
                <input type="radio" id="star5" name="rate" value="5" />
                <label for="star5" title="5">5 stars</label>
                <input type="radio" id="star4" name="rate" value="4" />
                <label for="star4" title="4">4 stars</label>
                <input type="radio" id="star3" name="rate" value="3" />
                <label for="star3" title="3">3 stars</label>
                <input type="radio" id="star2" name="rate" value="2" />
                <label for="star2" title="2">2 stars</label>
                <input type="radio" id="star1" name="rate" value="1" />
                <label for="star1" title="1">1 star</label>
            </div>
        </form>
      </div>
       <div class="modal-footer">
        <button id="closeButtonId" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="rateButtonId" type="button" class="btn btn-primary">Rate</button>
      </div> 
    </div>
  </div>
</div>
<p>
    <label>Page number:</label>
    {{ current_page.number }}
</p>
<p>
    <label>Page content:</label>
    {{ current_page.content }}
</p>

{% if 'Submit' in button_type %}
<form method="post" action="{% url 'course_page' course_pk=course_pk page_pk=page_pk %}">
{% endif %}
{% csrf_token %}
{% for task in tasks %}
<p>
    <label id="q_{{ task.question.pk }}">
        Question:
    </label>
    {{ task.question.content }}
</p>
<p>
    <label>Variants:</label>
    {% for variant_pk, variant in task.variants %}
    <p>
        <div class="" id="q_{{ task.question.pk}}_v_{{ variant_pk }}">
            <input
                {% if task_type %}
                type="{{ task_type }}"
                hidden
                {% else %}
                type="{{ task.question_types|get_item:task.question.type }}"
                value="{{ variant }}" 
                {% endif %}
                name="{{task.question.pk}}"
                id="q_{{ task.question.pk}}_v_{{ variant_pk }}_"
                {% if forloop.first and task.question_types|get_item:task.question.type == 'radio' %}
                required
                checked
                {% endif %}>
            {{ variant }}
        </div>
    </p>  
    {% endfor %}
</p>
{% endfor %}

{% if 'Next' in button_type %}
<a href="{% url 'course_page' course_pk=course_pk page_pk=next_page_pk %}">
{% elif 'Finish' in button_type or 'To course enrollment detail' in button_type %}
<a href="{% url 'course_welcom' course_pk=course_pk %}">
{% endif %}

<button id="buttonId" class="float-left btn btn-lg btn-primary"
        type="submit">{{button_type}}</button>

{% if 'Submit' in button_type %}
</form>
{% else %}
</a>
{% endif %}

{% endblock %}

{% block js_scripts %}
<script>
$(document).ready(function() {
    addClassById("{{ correct_questions }}", "correct");
    addClassById("{{ users_answers }}", "user-answer");

    if ("{{ button_type }}" === "Finish") {
        $("#modalId").modal('show');
    }
        
    $("#rateButtonId").click(async function() {
        let rate = $("input[name='rate']:checked").val();
        let post_data = {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            user: "{{ user }}",
            course_pk: "{{ course_pk }}",
            rate: rate
        };
        console.log(post_data);

        let response = await fetch("{% url 'course_rate' course_pk=course_pk %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify(post_data)
        });
        $("#modalId").modal('toggle');
    });

    function addClassById(element_ids, class_) {
        console.log(element_ids)
        if (element_ids != "None" && element_ids) {
            element_ids_ = element_ids.split(' ');
            element_ids_.forEach(function (item, index) {
            element_id = document.getElementById(item);
            element_id.className += class_;
        });
        }
    }
});
</script>
{% endblock %}